// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// Enums
enum Role {
  ADMIN
  ADMIN_CUSTOM
  MANAGER
  STAFF
  WATCHER
  USER
}

enum ProfileStatus {
  COMPLETED
  SKIPPED
}

enum CrockeryStatus {
  PENDING
  NOT_REQUIRED
  COMPLETED
}

enum EventStatus {
  BOOKED
  CANCELLED
  COMPLETED
}

// Models
model User {
  id            String         @id @default(cuid())
  username      String         @unique
  password      String
  email         String?
  mobile        String?
  name          String?
  role          Role           @default(STAFF)
  profileStatus ProfileStatus?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  events        Event[]        @relation("CreatedBy")
  moduleAccess  UserModuleAccess[]
  
  // Fee Relations
  feeConfig       UserFeeConfig?
  feeRecords      FeeRecord[]
  eventContributions EventContribution[]
  feeTransactions FeeTransaction[]

  @@map("users")
}

model InventoryItem {
  id                String   @id @default(cuid())
  name              String
  category          String
  totalQuantity     Int
  availableQuantity Int
  unit              String   @default("pcs")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relation to event allocations
  eventAllocations  EventInventory[]

  @@map("inventory_items")
}

// Track inventory allocations per event - single source of truth
model EventInventory {
  id            String        @id @default(cuid())
  eventId       String
  event         Event         @relation(fields: [eventId], references: [id], onDelete: Cascade)
  itemId        String
  item          InventoryItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  
  issuedQty     Int           @default(0)  // Total issued to this event
  returnedQty   Int           @default(0)  // Total returned from this event
  lostQty       Int           @default(0)  // Total reported lost
  recoveredQty  Int           @default(0)  // Total recovered from lost
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@unique([eventId, itemId])  // One record per event-item pair
  @@map("event_inventory")
}

model Event {
  id                  String         @id @default(cuid())
  name                String
  mobile              String
  email               String?
  occasionDate        DateTime
  occasionDay         String?
  occasionTime        String
  description         String
  hall                String[]
  catererName         String
  catererPhone        String
  
  thaalCount          Int            @default(0)
  totalThaalsDone     Int?           // Actual thaals served (filled after event)
  sarkariThaalSet     Int            @default(0)
  bhaiSaabIzzan       Boolean        @default(false)
  benSaabIzzan        Boolean        @default(false)
  extraChilamchiLota  Int            @default(0)
  tablesAndChairs     Int            @default(0)
  mic                 Boolean        @default(false)
  crockeryRequired    Boolean        @default(false)
  thaalForDevri       Boolean        @default(false)
  paat                Boolean        @default(false)
  masjidLight         Boolean        @default(false)
  crockeryStatus      CrockeryStatus @default(NOT_REQUIRED)
  
  acStartTime         String?
  partyTime           String?
  decorations         Boolean        @default(false)
  gasCount            Int?
  menu                String?
  
  status              EventStatus    @default(BOOKED)
  
  // New Fields for Public/Private Logic
  eventType           EventType      @default(PRIVATE)
  hallCounts          Json?          // Stores { "Hall A": 50, "Hall B": 30 }
  
  // Payment Info
  paymentMode         String?        // "CASH" | "UPI"
  transactionId       String?        // UPI Transaction ID
  
  razaGranted         Boolean        @default(false)
  
  refundedDate        DateTime?      // For refundable deposit tracking on print (Manual entry mostly, but useful)
  
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
  
  createdBy           User?          @relation("CreatedBy", fields: [createdById], references: [id])
  createdById         String?

  // Relation to inventory allocations
  inventoryAllocations EventInventory[]

  @@map("events")
}

enum EventType {
  PUBLIC
  PRIVATE
}

model Caterer {
  id    String @id @default(cuid())
  name  String @unique
  phone String

  @@map("caterers")
}

model Hall {
  id         String      @id @default(cuid())
  name       String      @unique
  width      Float?      // Width in feet
  length     Float?      // Length in feet
  floorPlans FloorPlan[]

  @@map("halls")
}

model FloorPlan {
  id          String   @id @default(cuid())
  name        String   // e.g., "Wedding Setup"
  hallId      String
  hall        Hall     @relation(fields: [hallId], references: [id], onDelete: Cascade)
  data        Json     // Stores items: { id, type, x, y, rotation, ... }[]
  width       Float    // Snapshot of width used
  length      Float    // Snapshot of length used
  isPublic    Boolean  @default(false)
  publicToken String?  @unique @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("floor_plans")
}

model FloorItemType {
  id        String   @id @default(cuid())
  name      String   // e.g. "Royal Round Table"
  type      String   // 'circle' | 'rectangle'
  width     Float    // Feet
  length    Float    // Feet
  color     String?  // hex or tailwind class
  icon      String?  // lucide icon name
  createdAt DateTime @default(now())
  
  @@map("floor_item_types")
}

model Config {
  id    String @id @default(cuid())
  key   String @unique
  value String

  @@map("config")
}

model KhidmatRequest {
  id        String   @id @default(cuid())
  miqat     String
  name      String
  phone     String
  date      DateTime
  status    String   @default("PENDING") // PENDING, APPROVED, REJECTED
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("khidmat_requests")
}

model MemberRegistration {
  id          String   @id @default(cuid())
  title       String
  name        String
  its         String   @unique
  email       String
  dob         DateTime
  phone       String
  quranHifz   String
  passport    String
  kunSafar    String
  occupation  String
  sports      String
  status      String   @default("PENDING")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("member_registrations")
}

model Blog {
  id          String   @id @default(cuid())
  title       String
  content     String   @db.Text
  author      String
  publishedAt DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("blogs")
}

model Banner {
  id              String   @id @default(cuid())
  imageUrl        String
  href            String?
  isActive        Boolean  @default(false)

  // Countdown Features
  countdownTarget DateTime?
  countdownLabel  String?
  x               Float?   @default(50)
  y               Float?   @default(50)
  countdownSize   String?  @default("normal")
  countdownColor  String?  @default("gold")

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("banners")
}

// Module-Based Access Control
model Module {
  id          String   @id // Slugified from name (e.g., "manage-banners")
  name        String   @unique  // Display name: "Manage Banners"
  description String?
  icon        String?            // Lucide icon name
  createdAt   DateTime @default(now())
  
  links       ModuleLink[]
  userAccess  UserModuleAccess[]
  
  @@map("modules")
}

// Multiple links per module - supports dynamic routes
model ModuleLink {
  id        String   @id @default(cuid())
  moduleId  String
  module    Module   @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  path      String            // Route path (can include [params] for dynamic routes)
  label     String?           // Optional display label for this specific link
  order     Int      @default(0)
  
  @@map("module_links")
}

model UserModuleAccess {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  moduleId  String
  module    Module   @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@unique([userId, moduleId])
  @@map("user_module_access")
}

model VerificationCode {
  id        String   @id @default(cuid())
  email     String
  code      String
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([email])
  @@map("verification_codes")
}

// Fee Management Models

model UserFeeConfig {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  amount    Int      @default(0) // Default monthly fee
  updatedAt DateTime @updatedAt

  @@map("user_fee_configs")
}

enum FeeStatus {
  PENDING
  PARTIAL
  PAID
}

model FeeRecord {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  month       Int       // 0-11
  year        Int
  amount      Int       // Amount due for this month
  paidAmount  Int       @default(0)
  status      FeeStatus @default(PENDING)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  allocations FeeTransactionAllocation[]

  @@unique([userId, month, year])
  @@map("fee_records")
}

model FeeTransaction {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  amount    Int
  mode      String   // UPI, CASH
  reference String?  // UPI Ref ID
  note      String?
  date      DateTime @default(now())

  allocations FeeTransactionAllocation[]

  @@map("fee_transactions")
}

// Event / Ad-hoc Contributions
model EventContribution {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  title       String    // e.g. "Urs Mubaraka 1446H"
  amount      Int
  paidAmount  Int       @default(0)
  status      FeeStatus @default(PENDING)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  allocations FeeTransactionAllocation[]

  @@map("event_contributions")
}

model FeeTransactionAllocation {
  id                 String             @id @default(cuid())
  transactionId      String
  transaction        FeeTransaction     @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  
  // Allocate to either Monthly Fee OR Event Contribution
  feeRecordId        String?
  feeRecord          FeeRecord?         @relation(fields: [feeRecordId], references: [id], onDelete: Cascade)

  eventContributionId String?
  eventContribution   EventContribution? @relation(fields: [eventContributionId], references: [id], onDelete: Cascade)

  allocatedAmount    Int

  @@map("fee_transaction_allocations")
}

